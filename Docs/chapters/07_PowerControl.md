\### Глава 7. Управление питанием и защитами (PowerControl)



Модуль `PowerControl` отвечает за реализацию ключевых защит системы ЛБП, включая температурную, токовую, управление выходом, а также анализ корректности работы.



---



\#### \*\*7.1 Назначение модуля PowerControl\*\*



PowerControl выполняет:



\* Температурную защиту (NTC)

\* Токовую защиту (ограничение и предохранитель)

\* Управление выходным MOSFET-ключом

\* Учёт режима работы (авто/ручной)

\* Поддержку ручного отключения выхода (`manualOutputEnable`)

\* Реакцию на аномалии измерений (ошибки датчика, обрыв, скачки)



---



\#### \*\*7.2 Температурная защита\*\*



\* Датчик: NTC 10к при 25 °C, B=3470

\* Сопротивление рассчитывается через делитель и `analogReadMilliVolts()`

\* Алгоритм: формула Штейнхарта–Харта

\* Фильтрация: экспоненциальное сглаживание, α = 0.05

\* Интервал измерения: 1 секунда

\* Порог отключения: `tempLimitC` (глобальная переменная, по умолчанию 70 °C)

\* При превышении — выходной MOSFET отключается, выводится ошибка



---



\#### \*\*7.3 Режимы управления выходом\*\*



\* `modeAuto = true` — автоматическое регулирование напряжения по ШИМ

\* `modeAuto = false` — ручной режим, контроллер не вмешивается в ОС, но все защиты активны

\* `manualOutputEnable = false` — ручное отключение выхода через интерфейс, включение по команде



---



\#### \*\*7.4 MOSFET-ключ выхода\*\*



\* Управление пином `MOSFET\_OUT\_PIN` из `Config.h`

\* HIGH — выход включён, LOW — выключен

\* Управляется через `setOutputMOSFET(bool)`

\* Состояние доступно через `isOutputMOSFETOn()`

\* Контроль производится на каждом вызове `update()`



---



\#### \*\*7.5 Токовая защита (в разработке)\*\*



\* Лимит тока: `labI\_limit`

\* Предохранитель: `labI\_fuse`

\* Реакции: ограничение тока, отключение выхода, вывод сообщения об ошибке

\* Планируется: анализ мощности источника (Psrc\\\_max), защита от перегрузки адаптера



---



\#### \*\*7.6 Обработка ошибок и аномалий\*\*



\* Центральная точка: `handleError(const char\*)`

\* Вызов отключает выход, фиксирует сообщение

\* Потенциальные причины: перегрев, перегрузка по току, обрыв датчика, расхождение установленных и измеренных значений

\* В будущем: логирование, отображение ошибки на дисплее и в веб-интерфейсе



---



\#### \*\*7.7 Расширения (в планах)\*\*



\* Автоматическое управление напряжением (`controlVoltage()`)

\* Градиентные защиты: динамическое снижение параметров при ухудшении условий

\* Поддержка пресетов, предустановок

\* Протоколирование событий и ошибок

\* Передача статуса и ограничений в интерфейс и дисплей

\* Адаптация под работу с разными модулями DC/DC



Модуль обновляется в основном цикле `loop()` с регулярным вызовом `PowerControl::update()` и работает независимо от интерфейса, обеспечивая базовую безопасность системы.



